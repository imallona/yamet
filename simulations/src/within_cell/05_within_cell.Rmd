---
title: "Within Cell Variability as a function of Variability Index"
author: "Atreya Choudhury"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    code_folding: hide
    number_sections: no
    fig_crop: yes
---

## Strategy

The goal is to generate features with various heterogeneity levels for the purpose of within cell differentiation.
That means features should be differentiable, not by the heterogeneity between different samples, but by heterogeneity between individual lines.
This means we want features to be differentiable in terms of their sample entropy but not their 2-mer shannon entropy.

Consider the sequence $0011\; 0$.
Notice that every 2-mer is seen exactly once.
This can be generalised to longer sequences, say $0011\; 0011\; 0011\; 0$.
Here, all the 2-mers have the same frequency.
Similary, the sequence $0110\; 0$ has the same property.
We will refer to these short sequences as snips.
Putting these two together, observe the two sequences below.

$$0011\; 0011\; 0110\; 0110\; 0$$
$$0011\; 0110\; 0011\; 0110\; 0$$

They both have the same distribution of 2-mers but differ in their sample entropy (the second one having higher sample entropy).
This provides the basis of our simulation framework.
For each feature, we start with a sequence where the first half is made up of $0011$s and the second is made up of $0110$s.
For each feature, we pick a certain fraction of snips (equally from the two halves) in proportion to a true variability index.
These snip positions differ between different features (even ones with the same variability index) but are the same for different samples within the same feature.
The snips at the selected positions are then shuffled in the different samples.
The idea is that features where a higher fraction of snips were shuffled exhibit higher sample entropy compared to those where a lower fraction of snips were shuffled.

We start by creating a template for a cell.
We have a fixed number of features, the length of each feature is taken to be the same and the number of simulated CpG sites is the same as well.
Every feature is given a **Variability Index (VI)** between 1 and 10 and stored in the `vi` column.
As described above we pick a fraction of snips in proportion to the feature's `vi`.
This is stored in the `snip_pos` column.
This template file can now be used for generating new samples and also for running `yamet` on the simulated data.

With the template, we now generate samples as described above.
For samples within the same feature, we shuffle the snips at the positions described in `snip_pos`.
At this stage, observe that the all the features in all the samples are approximately $50\%$ methylated and that this value is the same for all the samples.
To ensure that scMET is able to process this data, we introduce some more randomness.
We pick $30\%$ of positions at random from each feature and each cell and set them to $0$.

```{r, setup}
suppressPackageStartupMessages({
  library(ggplot2)
  library(scMET)
})
source("src/mi_table.R")
```

## Variation

```{r}
get_combs <- function(GRID) {
  combinations <- expand.grid(GRID)
  tuples <- lapply(seq_len(nrow(combinations)), function(i) {
    as.list(combinations[i, ])
  })
  return(tuples)
}

get_mi <- function(S, N, f) {
  intervals <- read.table(
    paste0(data_dir, paste("/intervals", S, N, f, "tsv", sep = ".")),
    header = T
  )
  intervals <- intervals["vi"]
  sampens <- read.table(
    paste0(data_dir, paste("/yamet", S, N, f, "det.out", sep = ".")),
    header = T
  )
  jnt <- cbind(sampens, intervals)
  output_cols <- grep("^output", colnames(jnt), value = TRUE)

  scmet_fit <- readRDS(paste0(data_dir, paste("/scmet", S, N, f, "rds", sep = ".")))
  scmet_fit$posterior$epsilon_avg <- colMeans(scmet_fit$posterior$epsilon)
  scmet_fit$posterior$gamma_avg <- colMeans(scmet_fit$posterior$gamma)
  scmet_fit$posterior$mu_avg <- colMeans(scmet_fit$posterior$mu)

  jnt$sampen_avg <- rowMeans(jnt[, output_cols])

  mi_table <- mi_table_gen(jnt, scmet_fit, jnt$vi)
  return(mi_table)
}
```

### with S

```{r}
data_dir <- dirname(snakemake@input[["disp_scmet"]])
S_GRID <- snakemake@params[["S_GRID"]]

bm_data <- do.call(
  rbind,
  lapply(get_combs(S_GRID), function(row) {
    S <- row$S
    N <- row$N
    f <- row$f
    do.call(rbind, lapply(c("yamet", "scmet"), function(mtd) {
      bm <- read.table(paste0(
        data_dir, "/", paste(mtd, S, N, f, "benchmark", sep = ".")
      ), header = T)
      bm$mtd <- mtd
      bm$S <- S
      bm$N <- N
      bm$f <- f
      bm
    }))
  })
)

mi_data <- do.call(
  rbind,
  lapply(get_combs(S_GRID), function(row) {
    S <- row$S
    N <- row$N
    f <- row$f
    mi_table <- get_mi(S, N, f)
    mi_table$S <- S
    mi_table$N <- N
    mi_table$f <- f
    mi_table
  })
)

ggplot(mi_data, aes(x = S, y = NMI, color = Metric, group = Metric)) +
  scale_y_log10() +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  # scale_color_manual(values = c("yamet" = "#E69F00", "scmet" = "#56B4E9")) +
  labs(
    title = "NMI Comparison",
    x = "S (Parameter Value)",
    y = "NMI",
    color = "Metric"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5),
    panel.grid.minor = element_blank()
  )


ggplot(bm_data, aes(x = S, y = s, color = mtd, group = mtd)) +
  scale_y_log10() +
  geom_point(size = 3, alpha = 0.7) +
  stat_summary(fun = mean, geom = "line", linewidth = 1.2, aes(group = mtd)) +
  scale_color_manual(values = c("yamet" = "#E69F00", "scmet" = "#56B4E9")) +
  labs(
    title = "Runtime Comparison: scmet vs yamet",
    x = "S (Parameter Value)",
    y = "seconds (log scale)",
    color = "Method"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5),
    panel.grid.minor = element_blank()
  )

ggplot(bm_data, aes(x = S, y = max_rss, color = mtd, group = mtd)) +
  scale_y_log10() +
  geom_point(size = 3) +
  stat_summary(fun = mean, geom = "line", linewidth = 1.2, aes(group = mtd)) +
  scale_color_manual(values = c("yamet" = "#E69F00", "scmet" = "#56B4E9")) +
  labs(
    title = "Memory Comparison: scmet vs yamet",
    x = "S (Parameter Value)",
    y = "MB (log scale)",
    color = "Method"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5),
    panel.grid.minor = element_blank()
  )
```

## One Example

```{r}
DISP <- snakemake@params[["DISP"]]
S <- DISP$S
N <- DISP$N
f <- DISP$f

intervals <- read.table(
  paste0(data_dir, paste("/intervals", S, N, f, "tsv", sep = ".")),
  header = T
)
intervals <- intervals["vi"]
sampens <- read.table(
  paste0(data_dir, paste("/yamet", S, N, f, "det.out", sep = ".")),
  header = T
)
jnt <- cbind(sampens, intervals)
output_cols <- grep("^output", colnames(jnt), value = TRUE)
jnt.long <- do.call(rbind, lapply(output_cols, function(col) {
  data.frame(
    start = jnt$start,
    end = jnt$end,
    sample = col,
    sampen = jnt[[col]],
    shannon = jnt$shannon,
    avg_meth = jnt$avg_meth,
    vi = jnt$vi
  )
}))

meth <- read.table(
  paste0(data_dir, paste("/yamet", S, N, f, "meth.out", sep = ".")),
  header = TRUE
)
meth.long <- do.call(rbind, lapply(output_cols, function(col) {
  data.frame(
    meth = meth[[col]]
  )
}))

all.long <- cbind(jnt.long, meth.long)

ggplot(all.long, aes(x = meth, y = sampen, color = vi)) +
  geom_point(alpha = 0.7) +
  theme_minimal() +
  labs(
    title = "Sample Entropy in different VI values",
    x = "Average Methylation", y = "Sample Entropy", color = "VI"
  )

ggplot(all.long, aes(x = as.factor(vi), y = sampen)) +
  geom_point(alpha = 0.7, position = position_jitter(width = 0.2)) +
  geom_violin(alpha = 0.3, position = position_dodge(0.8)) +
  theme_minimal() +
  labs(
    title = "Sample Entropy in different VI values",
    x = "VI", y = "Sample Entropy"
  )

ggplot(jnt, aes(x = avg_meth, y = shannon, color = vi)) +
  geom_point(alpha = 0.7) +
  theme_minimal() +
  labs(
    title = "Shannon Entropy in different VI values (per feature)",
    x = "Average Methylation", y = "Shannon Entropy", color = "VI"
  )

ggplot(jnt, aes(x = as.factor(vi), y = shannon, color = avg_meth)) +
  geom_point(alpha = 0.7) +
  theme_minimal() +
  labs(
    title = "Shannon Entropy in different VI values (per feature)",
    x = "VI", y = "Shannon Entropy", color = "meth"
  )

ggplot(all.long, aes(x = shannon, y = sampen, color = vi)) +
  geom_point(alpha = 0.7) +
  theme_minimal() +
  labs(
    title = "Sample Entropy in different VI values",
    x = "Shannon Entropy", y = "Sample Entropy", color = "VI"
  )
```

```{r}
scmet_fit <- readRDS(paste0(data_dir, paste("/scmet", S, N, f, "rds", sep = ".")))
scmet_fit$posterior$epsilon_avg <- colMeans(scmet_fit$posterior$epsilon)
scmet_fit$posterior$gamma_avg <- colMeans(scmet_fit$posterior$gamma)
scmet_fit$posterior$mu_avg <- colMeans(scmet_fit$posterior$mu)
```

```{r}
scmet_plot_mean_var(
  obj = scmet_fit, y = "gamma",
  task = NULL, show_fit = TRUE
)
scmet_plot_mean_var(
  obj = scmet_fit, y = "epsilon",
  task = NULL, show_fit = TRUE
)
```

```{r}
jnt$sampen_avg <- rowMeans(jnt[, output_cols])
mi_table_gen(jnt, scmet_fit, jnt$vi, table = T)
```