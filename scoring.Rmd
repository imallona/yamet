---
title: "CpG entropies scoring"
params:
  seed: 1
author: "Izaskun Mallona (Mark Robinson, Tuncay Baubec labs)"
output:
  html_document:
    keep_md: true
    toc: true
    toc_float: true
    toc_depth: 4

---

```{r libraries, include=FALSE, cache = FALSE}
library('latex2exp')
library(entropy)
library(cramer)
library(Cairo)
library(knitr)

ac  <- function(col, alpha=1){
  apply(sapply(col, col2rgb)/255, 2, 
                     function(x) 
                       rgb(x[1], x[2], x[3], alpha=alpha))  
}

opts_chunk$set(fig.width = 12,
               fig.height = 12,
               cache = TRUE,
               include = TRUE,
               cache.lazy = FALSE,
               warning = TRUE,
               message = TRUE)


options(bitmapType='cairo')
getOption('bitmapType')


```
# Data load

```{r}
load('data/test_data.RData')

dim(d)
```

# Modeling entropies constraints

Estimating the unmethylated and methylated tuples according to the beta value and coverage

```{r}

d$pU <- (d$cov - (d$cov * d$beta))/d$cov
d$pM <- 1 - d$pU

```

```{r}
d$max_entropy <- apply(data.frame(pUU = d$pU^2,
                                  pUM = d$pU * d$pM,
                                  pMU = d$pU * d$pM,
                                  pMM = d$pM^2),
                       1, entropy)


d$min_entropy_full <- apply(data.frame(pUU = d$pU,
                                       pUM = 0,
                                       pMU = 0,
                                       pMM = d$pM),
                            1, entropy)


## d$min_entropy_beta <- apply(data.frame(pUU = 0,
##                                   pUM = abs(d$pM - d$pU)/2 ,
##                                   pMU =  0,
##                                   pMM = ifelse(d$beta >= 0.5,
##                                                yes = d[d$beta < 0.5, 'pM'],
##                                                no = d[d$beta >= 0.5, 'pU'])),
##                             1, entropy)


d$min_entropy_beta <- apply(data.frame(pUU = 0,
                                  pUM = abs(d$pM - d$pU)/2 ,
                                  pMU =  0,
                                  pMM = d$pM),
                   1, entropy)

d$min_entropy_beta[d$beta >= 0.5] <- apply(data.frame(pU = 0,
                                  pUM = abs(d[d$beta >= 0.5,]$pM - d[d$beta >= 0.5,]$pU)/2 ,
                                  pMU =  0,
                                  pMM = d[d$beta >= 0.5,]$pU),
                                  1, entropy)


d$lower_bound <- apply(d[,c('min_entropy_full', 'min_entropy_beta')], 1, min)
```

```{r plotsbounds}

par(cex.axis = 1.4,
    cex.lab = 1.4,
    cex.main = 1.4,
    cex.sub = 1.4,
    pty = "s",
    mar=c(5.1,4.1,4.1,2.1),
    oma = c(4, 4, 1, 1))

plot(d$beta, d$entropy, pch = 19, col = ac('black', 0.5),
     xlab = 'methylation (beta value)',
     ylab = "Shannon's entropy (H)" )
lines(d$beta, d$max_entropy, col = 'darkred', type = 'p', pch = 4, cex = 1)
## lines(d$beta, d$min_entropy_beta, col = 'blue', type = 'p', pch = 19, cex = 0.5)
## lines(d$beta, d$min_entropy_full, col = 'darkred', type = 'p', pch = 19, cex = 0.5)
lines(d$beta, d$lower_bound, col = 'darkblue', type = 'p', pch = 4, cex = 1)

legend('topright',
       col = c('black', 'darkred', 'darkblue'),
       pch = c(19, 4, 4),
       legend = c('observation', TeX('$H_{max}$'), TeX('$H_{min}$')))



```

Standardizing entropy values to the min and max theoretical entropies

```{r}

d$standardized_entropy <- (d$entropy - d$lower_bound) / (d$max_entropy - d$lower_bound)

summary(d$standardized_entropy)

d$standardized_entropy[is.na(d$standardized_entropy)] <- 0
head(d[d$standardized_entropy == 0, c('code', 'beta', 'entropy', 'standardized_entropy')])


par(cex.axis = 1.4,
    cex.lab = 1.4,
    cex.main = 1.4,
    cex.sub = 1.4,
    pty = "s",
    mar=c(5.1,4.1,4.1,2.1),
    oma = c(4, 4, 1, 1))

plot(d$beta, d$standardized_entropy, pch = 19, col = ac('black', 0.5),
     xlab = 'methylation (beta value)',
     ylab = "standardized entropy (stdH)" )

legend('topright',
       col = c('black', 'darkred', 'darkblue'),
       pch = c(19, 4, 4),
       legend = c('observation', TeX('$H_{max}$'), TeX('$H_{min}$')))

```

```{r}

targets <- c('coverage',
             ## 'distance',
             'beta',
             'entropy',
             'standardized_entropy')
summary(d[,targets])

plot(d[,targets])


```

```{r plotbycolors}


hmm_colors <- read.table(text = "Art
Ctcf
CtcfO
DnaseD
DnaseU
Elon
ElonW
Enh
EnhF
EnhW
EnhWF
FaireW
Gen3'
Gen5'
H4K20
Low
Pol2
PromF
PromP
Quies
Repr
ReprD
ReprW
Tss
TssF", stringsAsFactors = FALSE)$V1


for (hmm in hmm_colors) {
    curr <- d[d[,hmm],]

    ## downsampling for plotting purposes
    set.seed(1)
    curr <- curr[sample(x=nrow(curr), 1e3),]
    
    targets <- c('coverage',
                 ## 'distance',
                 'beta',
                 'entropy',
                 'standardized_entropy')


    plot(curr[,targets], main = hmm)

    
    rm(curr)
}

```

# Cramer tests

```{r cramer}
tests <- list()

for (i in 1:length(hmm_colors)) {
    for (j in i+1:length(hmm_colors)) {

        ## caution, downsampling!

        
        foo <- cramer.test(head(as.matrix(d[d[,hmm_colors[i]],c('beta', 'entropy')]), 1e3),
                           head(as.matrix(d[d[,hmm_colors[i]],c('beta', 'entropy')]), 1e3),
                           sim = "eigenvalue")

        ## stop()
        
        tests[[paste(hmm_colors[i], hmm_colors[j], 'bivariate', 'entropy')]] <- c(hmm_colors[i],
                                                                                  hmm_colors[j],
                                                                                  'entropy',
                                                                                  'bivariate',
                                                                                  foo$p.value,
                                                                                  foo$statistic)
        rm(foo)


        foo <- cramer.test(head(as.matrix(d[d[,hmm_colors[i]],c('beta', 'standardized_entropy')]), 1e3),
                           head(as.matrix(d[d[,hmm_colors[i]],c('beta', 'standardized_entropy')]), 1e3),
                           sim = "eigenvalue")
        tests[[paste(hmm_colors[i], hmm_colors[j],
                     'bivariate', 'standardized_entropy')]] <- c(hmm_colors[i],
                                                                 hmm_colors[j],
                                                                 'standardized_entropy',
                                                                 'bivariate',
                                                                 foo$p.value,
                                                                 foo$statistic)
        rm(foo)


        foo <- ks.test(d[d[,hmm_colors[i]],'entropy'],
                       d[d[,hmm_colors[i]],'entropy'])
        tests[[paste(hmm_colors[i], hmm_colors[j], 'univariate', 'entropy')]] <- c(hmm_colors[i],
                                                                                   hmm_colors[j],
                                                                                   'entropy',
                                                                                   'univariate',
                                                                                   foo$p.value,
                                                                                   foo$statistic)
        rm(foo)


        foo <- ks.test(d[d[,hmm_colors[i]],'standardized_entropy'],
                       d[d[,hmm_colors[i]], 'standardized_entropy'])
        tests[[paste(hmm_colors[i], hmm_colors[j], 'univariate',
                     'standardized_entropy')]] <- c(hmm_colors[i],
                                                    hmm_colors[j],
                                                    'standardized_entropy',
                                                    'univariate',
                                                    foo$p.value,
                                                    foo$statistic)
        rm(foo)

        ## control
        foo <- ks.test(d[d[,hmm_colors[i]],'beta'],
                       d[d[,hmm_colors[i]],'beta'])
        tests[[paste(hmm_colors[i], hmm_colors[j], 'univariate',
                     'beta')]] <- c(hmm_colors[i],
                                    hmm_colors[j],
                                    'beta',
                                    'univariate',
                                    foo$p.value,
                                    foo$statistic)
        rm(foo)
        ## cat('.')
        

    }
}
```


```{r sessioinfo}
devtools::session_info()
```
