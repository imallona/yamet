---
title: "yamet on CRC rought draft"
author: "Izaskun Mallona"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    code_download: true
    number_sections: true
    df_print: kable
    theme: lumen
    keep_md: true
params:
  seed: 666
---

Caution this is a draft, not pretty! Run `crc_prototype.sh` first.


```{r}
library(ggplot2)
## library(ComplexHeatmap)

options(bitmapType="cairo")
library(showtext) ; showtext_auto()
library(knitr)
```

```{r}
opts_chunk$set(fig.width = 5,
               fig.height = 5,
               cache = FALSE,
               include = TRUE,
               dev = c("png"),#, "svg"),
               cache.lazy = FALSE,
               warning = FALSE,
               message = TRUE)
```


```{r, fig.width = 10, fig.height = 5}
# setwd('/home/imallona/tmp/yamet_crc')
datapath <- '~/src/yamet/data/crc/prototype/' 
fns <- list.files(datapath, pattern = '*.out')

global <- list()
for (fn in fns) {
    global[[fn]] <- read.table(file.path(datapath, fn), header = TRUE)
    global[[fn]]$status <- ifelse(grepl('normal', fn), 'nc', 'pt')
    global[[fn]]$type <- gsub('.yamet.out', '', basename(fn))
}

global <- do.call(rbind.data.frame, global)

ggplot(global,
       aes(y = sampen, x = type, color = status)) +
    geom_violin() + geom_point() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(global,
       aes(y = avg_meth, x = type, color = status)) +
    geom_point() + geom_point() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r, fig.width = 10, fig.height = 8}

ggplot(global,
       aes(y = sampen, x = avg_meth, color = status)) +
    geom_point() + geom_point() +
    facet_wrap(~type) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```


ok, looks promising, let's go for detailed outputs to check rank inversions! Caution not reading the whole files

```{r}

fns <- list.files(datapath, pattern = '*normals.yamet.det.out')

local <- list(nc = list(),
              pt = list())
for (fn in fns) {
    local$nc[[fn]] <- read.table(file.path(datapath, fn), header = TRUE, nrows = 50000, na.strings = "-1")
    local$nc[[fn]]$status <- ifelse(grepl('normal', fn), 'nc', 'pt')
    local$nc[[fn]]$type <- gsub('.yamet.out', '', basename(fn))
}

fns <- list.files('.', pattern = '*primaries.yamet.det.out')

for (fn in fns) {
    local$pt[[fn]] <- read.table(file.path(datapath, fn), header = TRUE, nrows = 50000, na.strings = "-1")
    local$pt[[fn]]$status <- ifelse(grepl('normal', fn), 'pt', 'pt')
    local$pt[[fn]]$type <- gsub('.yamet.out', '', basename(fn))
}

```

<!-- superdirty, correlation plots of some pt vs some pt cells for some segmentation, e.g. quiescent -->

<!-- ```{r} -->

<!-- tumors <- local$pt$`10_Quiescent_primaries.yamet.det.out` -->
<!-- normals <- local$nc$`10_Quiescent_normals.yamet.det.out` -->

<!-- set.seed(36) -->
<!-- ts <- sample(ncol(tumors[,grep('yametized', colnames(tumors))]), 5) -->
<!-- set.seed(35466) -->
<!-- ns <- sample(ncol(normals[,grep('yametized', colnames(normals))]), 5) -->


<!-- tumors <- tumors[,grep('yametized', colnames(tumors), value = TRUE)[ts]] -->
<!-- normals <- normals[,grep('yametized', colnames(normals), value = TRUE)[ns]] -->

<!-- fd <- cbind(normals, tumors) -->
<!-- dim(fd) -->
<!-- plot(fd, pch = 19) -->
<!-- ``` -->

<!-- Same with per feature heatmaps -->

<!-- ```{r} -->
<!-- # reduce sparsity -->

<!-- fd <- fd[apply(fd, 1, function(x) sum(is.na(x)) < 5),] -->


<!-- ## order according to the normals' entropy -->

<!-- fd <- fd[names(sort(apply(fd, 1, function(x) mean(x, na.rm = TRUE)))),] -->


<!-- Heatmap(as.matrix(fd), cluster_rows = FALSE, cluster_columns = FALSE) -->

<!-- ``` -->

Wait, let's browse the shannon's and avg meths to double check this is ok.



```{r, fig.width = 10, fig.height = 10}


normals <- local$nc$`windows_normals.yamet.det.out`
## normals <- normals[order(normals$avg_meth),]

tumors <- local$pt$`windows_primaries.yamet.det.out`[rownames(normals),]

plot(data.frame(shannon_nc = normals$shannon,
                meth_nc = normals$avg_meth,
                shannon_pt = tumors$shannon,
                meth_pt = tumors$avg_meth), pch = ".")
```

As wild as it is, let's get an average and max sampen (bound by meth level) per window, so we have extra controls and a better overview


```{r, fig.width = 12, fig.height = 12}
normals$avg_sampen <- apply(normals[,grep('nc', colnames(normals))], 1, function(x) mean(x, na.rm = TRUE))
tumors$avg_sampen <- apply(tumors[,grep('pt', colnames(tumors))], 1, function(x) mean(x, na.rm = TRUE))

normals$max_sampen <- apply(normals[,grep('nc', colnames(normals))], 1, function(x) max(x, na.rm = TRUE))
tumors$max_sampen <- apply(tumors[,grep('pt', colnames(tumors))], 1, function(x) max(x, na.rm = TRUE))

plot(data.frame(shannon_nc = normals$shannon,
                meth_nc = normals$avg_meth,
                avg_sampen_nc = normals$avg_sampen,
                max_sampen_nc = normals$max_sampen,
                shannon_pt = tumors$shannon,
                meth_pt = tumors$avg_meth,
                avg_sampen_pt = tumors$avg_sampen,
                max_sampen_pt = tumors$max_sampen),
     pch = '.',
     main = 'windows')

```

does this hold for enhancers? caution reusing variable names



```{r, fig.width = 12, fig.height = 12}
for (segmentation in c('0_Enhancer', '10_Quiescent')) {
    nname <- grep(segmentation, names(local$nc), value = TRUE)
    tname <- grep(segmentation, names(local$pt), value = TRUE)
    
    normals <- local$nc[[nname]]
    tumors <- local$pt[[tname]]

    normals$avg_sampen <- apply(normals[,grep('nc', colnames(normals))], 1, function(x) mean(x, na.rm = TRUE))
    tumors$avg_sampen <- apply(tumors[,grep('pt', colnames(tumors))], 1, function(x) mean(x, na.rm = TRUE))

    normals$max_sampen <- apply(normals[,grep('nc', colnames(normals))], 1, function(x) max(x, na.rm = TRUE))
    tumors$max_sampen <- apply(tumors[,grep('pt', colnames(tumors))], 1, function(x) max(x, na.rm = TRUE))

    plot(data.frame(shannon_nc = normals$shannon,
                    meth_nc = normals$avg_meth,
                    avg_sampen_nc = normals$avg_sampen,
                    max_sampen_nc = normals$max_sampen,
                    shannon_pt = tumors$shannon,
                    meth_pt = tumors$avg_meth,
                    avg_sampen_pt = tumors$avg_sampen,
                    max_sampen_pt = tumors$max_sampen),
         pch = '.',
         main = segmentation)
}
```

and for marks?


```{r, fig.width = 12, fig.height = 12}
for (mark in c('H3K27', 'H3K4me3', 'H3K9me3')) {
    nname <- grep(mark, names(local$nc), value = TRUE)
    tname <- grep(mark, names(local$pt), value = TRUE)
    
    normals <- local$nc[[nname]]
    tumors <- local$pt[[tname]]

    normals$avg_sampen <- apply(normals[,grep('nc', colnames(normals))], 1, function(x) mean(x, na.rm = TRUE))
    tumors$avg_sampen <- apply(tumors[,grep('pt', colnames(tumors))], 1, function(x) mean(x, na.rm = TRUE))

    normals$max_sampen <- apply(normals[,grep('nc', colnames(normals))], 1, function(x) max(x, na.rm = TRUE))
    tumors$max_sampen <- apply(tumors[,grep('pt', colnames(tumors))], 1, function(x) max(x, na.rm = TRUE))

    plot(data.frame(shannon_nc = normals$shannon,
                    meth_nc = normals$avg_meth,
                    avg_sampen_nc = normals$avg_sampen,
                    max_sampen_nc = normals$max_sampen,
                    shannon_pt = tumors$shannon,
                    meth_pt = tumors$avg_meth,
                    avg_sampen_pt = tumors$avg_sampen,
                    max_sampen_pt = tumors$max_sampen),
         pch = '.',
         main = mark)
}
```


# annotate windows by overlap with know features

Run `crc_prototype.sh` first (chunk `annotate windows by features`)

```{r}
annot <- read.table(gzfile(file.path(datapath, 'hg19_windows_annotation.tsv.gz')), header = TRUE)
```

First, cluster the annots to make sure they make sense to start with, without any sampens

```{r, fig.width = 12, fig.height = 6}

NROWS <- 5e4
mannot <- head(annot, NROWS)

plot(hclust(dist(t(mannot))))
```

Looks reasonable.

Let's do the same with the sampens.

```{r, fig.width = 12, fig.height = 10}

mnormals <- as.matrix(normals[1:NROWS, c(grep('nc.GSM', colnames(normals), value = TRUE), 'shannon', 'avg_meth', 'avg_sampen', 'max_sampen')])
mtumors <- as.matrix(tumors[1:NROWS, c(grep('pt.GSM', colnames(tumors), value = TRUE), 'shannon', 'avg_meth', 'avg_sampen', 'max_sampen')])

mnormals[!is.finite(mnormals)] <- NA
mtumors[!is.finite(mtumors)] <- NA

plot(hclust(dist(rbind(t(mnormals), t(mtumors)))))
```

Now, how can we evaluate the window assoc with the sampen?

```{r, fig.width = 10, fig.height = 10}
fd <- cbind(mannot[c('hg19_windows_8_Quiescent', 'hg19_windows_3_Quiescent', 'hg19_windows_9_ConstitutiveHet', 'hg19_windows_13_ConstitutiveHet',
                     'hg19_windows_H3K27me3',
                     'hg19_windows_H3K9me3', 'hg19_windows_H3K4me3')],
            mnormals[,c('shannon', 'avg_meth', 'avg_sampen', 'max_sampen')])

colnames(fd) <- gsub('hg19_windows_', '', colnames(fd))
plot(fd, pch = '.')

```

```{r, eval = FALSE}
summary(lm(avg_sampen ~ avg_meth + `8_Quiescent` * `3_Quiescent` * `9_ConstitutiveHet` * H3K27me3 + shannon, data = fd))
```

Issue is, we want to check actual sampens for pt, nc, metastasis etc.



```{r}
sessionInfo()
```
