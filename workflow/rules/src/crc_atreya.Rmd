---
title: "CRC"
author: "Atreya Choudhury, Izaskun Mallona"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    code_folding: hide
    theme: flatly
    number_sections: no
    fig_crop: yes
---

We require `readr`, `lmerTest` and `ggplot2` for our analysis.
```{r, setup}
suppressPackageStartupMessages({
  library(readr)
  library(lmerTest)
  library(ggplot2)
  library(Matrix)
  library(ComplexHeatmap)
  library(BiocParallel)
  library(limma)
})
```

Firstly, we read in the yamet output files and create a table storing the stage of cancer, patient and annotation type against the yamet output.
```{r, import}
filepaths <- list.files(
  snakemake@params[["yamet"]],
  pattern = "\\.out.gz$", full.names = T
)
filepaths <- filepaths[!grepl("\\.(det|norm|meth)\\.out.gz$|bookended\\.custom\\.", filepaths)]
process_file <- function(filepath) {
  filename <- basename(filepath)

  parts <- strsplit(filename, "\\.")[[1]]
  annotation <- parts[1]
  patient <- parts[3]
  stage <- parts[4]

  dt <- read_tsv(filepath, show_col_types = FALSE)
  dt <- dt[, c("sampen", "avg_meth")]

  dt$annotation <- annotation
  dt$patient <- patient
  dt$stage <- stage

  return(dt)
}

files <- do.call(rbind, lapply(filepaths, process_file))

files$annotation <- as.factor(files$annotation)
files$patient <- as.factor(files$patient)
files$stage <- as.factor(files$stage)
files[files == -1] <- NA
```

We account for fixed effects of stage and average methylation and a random effect from the patient.
```{r, lmer}
lmer.files <- lmer(
  sampen ~ stage * avg_meth + (1 | patient),
  data = subset(files, annotation == "pmds")
)
summary(lmer.files)
anova(lmer.files, type = 3)
```
We observe that the effect of the different stages on sample entropy is strongly confounded by the average methylation.

```{r, plot, out.width="100%"}
ggplot(
  subset(files, patient == "CRC01"),
  aes(y = sampen, x = avg_meth, color = stage)
) +
  geom_point(size = 0.9, alpha = 0.7) +
  scale_color_brewer(palette = "Dark2") +
  facet_wrap(~annotation) +
  labs(
    x = "average methylation",
    y = "sample entropy"
  ) +
  guides(color = guide_legend(override.aes = list(size = 2)))

ggplot(
  subset(files, patient == "CRC01"),
  aes(y = sampen, x = annotation, color = stage)
) +
  geom_boxplot(
    outlier.size = 0.6,
    outlier.alpha = 0.3
  ) +
  labs(y = "sample entropy") +
  geom_jitter(
    position = position_dodge(width = 0.75),
    size = 0.6, alpha = 0.3
  ) +
  scale_color_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(
  subset(files, patient == "CRC01"),
  aes(y = avg_meth, x = annotation, color = stage)
) +
  geom_boxplot(
    outlier.size = 0.6,
    outlier.alpha = 0.3
  ) +
  labs(y = "average methylation") +
  geom_jitter(
    position = position_dodge(width = 0.75),
    size = 0.6, alpha = 0.3
  ) +
  scale_color_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## Heatmap

We start by looking at differentially entropic regions and how the methylation levels look in these regions.
```{r}
filepaths <- list.files(
  snakemake@params[["yamet"]],
  pattern = "bookended\\.custom\\..*\\.det\\.out\\.gz$", full.names = T
)

process_reports <- function(filepath) {
  out_path <- gsub("\\.det", "", filepath)
  n_out_path <- gsub("\\.det\\.", ".norm.", filepath)
  m_out_path <- gsub("\\.det\\.", ".meth.", filepath)

  out <- read_tsv(out_path, show_col_types = FALSE, na = "-1")
  se <- read_tsv(filepath, show_col_types = FALSE, na = "-1")
  n_se <- read_tsv(n_out_path, show_col_types = FALSE, na = "-1")
  ms <- read_tsv(m_out_path, show_col_types = FALSE, na = "-1")

  rwnms <- paste0(se$chr, ":", se$start, "-", se$end)

  shannon <- se[, c("shannon", "avg_meth")]

  se <- as.matrix(se[, grep("singleC", colnames(se))])
  n_se <- as.matrix(n_se[, grep("singleC", colnames(n_se))])
  ms <- as.matrix(ms[, grep("singleC", colnames(ms))])

  rownames(se) <- rwnms
  rownames(n_se) <- rwnms
  rownames(ms) <- rwnms

  return(
    list(
      shannon = shannon,
      sampen = se, n_sampen = n_se, meth = ms, cell_meth = out$avg_meth
    )
  )
}

param <- MulticoreParam(workers = snakemake@threads)
all_data <- bplapply(filepaths, process_reports, BPPARAM = param)
sampens <- do.call(cbind, lapply(all_data, \(x) x$sampen))
n_sampens <- do.call(cbind, lapply(all_data, \(x) x$n_sampen))
meths <- do.call(cbind, lapply(all_data, \(x) x$meth))

meta <- data.frame(
  colname = colnames(sampens),
  patient = sapply(strsplit(colnames(sampens), "_"), \(x) x[3]),
  subloc = sapply(strsplit(colnames(sampens), "_"), \(x) x[4]),
  cell_meth = unlist(lapply(all_data, \(x) x$cell_meth), recursive = FALSE)
)
meta$loc <- substr(meta$subloc, 1, 2)
meta$loc <- relevel(factor(meta$loc), ref = "NC")
meta <- meta[order(as.integer(meta$loc), meta$subloc, meta$patient), ]
sampens <- sampens[, meta$colname]
n_sampens <- n_sampens[, meta$colname]
meths <- meths[, meta$colname]

groups <- unique(meta[c("subloc", "patient")])
groups <- groups[
  order(as.integer(substr(groups$subloc, 1, 2)), groups$subloc, groups$patient),
]
sub_sampens <- do.call(cbind, lapply(seq_len(nrow(groups)), \(i) {
  cols <- meta$colname[
    meta$patient == groups$patient[i] & meta$subloc == groups$subloc[i]
  ]
  rowMeans(sampens[, cols, drop = FALSE], na.rm = TRUE)
}))
colnames(sub_sampens) <- paste(groups$subloc, groups$patient, sep = "_")
sub_n_sampens <- do.call(cbind, lapply(seq_len(nrow(groups)), \(i) {
  cols <- meta$colname[
    meta$patient == groups$patient[i] & meta$subloc == groups$subloc[i]
  ]
  rowMeans(n_sampens[, cols, drop = FALSE], na.rm = TRUE)
}))
colnames(sub_n_sampens) <- paste(groups$subloc, groups$patient, sep = "_")
sub_meths <- do.call(cbind, lapply(seq_len(nrow(groups)), \(i) {
  cols <- meta$colname[
    meta$patient == groups$patient[i] & meta$subloc == groups$subloc[i]
  ]
  rowMeans(meths[, cols, drop = FALSE], na.rm = TRUE)
}))
colnames(sub_meths) <- paste(groups$subloc, groups$patient, sep = "_")
```

```{r}
design <- model.matrix(~ patient + loc + cell_meth, meta)
fit <- lmFit(sampens, design)
fit <- eBayes(fit)
regions <- rownames(topTable(fit, coef = "locPT", number = 500))
topTable(fit, coef = "locPT", number = 10)

dim(sub_sampens)
dim(sub_meths)
sub_sampens <- na.omit(sub_sampens[regions, ])
sub_meths <- na.omit(sub_meths[regions, ])
regions <- intersect(rownames(sub_sampens), rownames(sub_meths))
sub_sampens <- sub_sampens[regions, ]
sub_meths <- sub_meths[regions, ]
dim(sub_sampens)
dim(sub_meths)

annot <- read_tsv(snakemake@input[["annotation"]], show_col_types = FALSE)
rownames(annot) <- rownames(sampens)
get_row_annotations <- function(regions) {
  rowAnnotation(tile_annotation = as.matrix(data.frame(
    pmd = annot[regions, "pmds_pmd"],
    hmd = annot[regions, "hmds_pmd"],
    H3K27me3 = annot[regions, "H3K27me3_chip"],
    H3K9me3 = annot[regions, "H3K9me3_chip"],
    H3K4me3 = annot[regions, "H3K4me3_chip"],
    laminb1 = annot[regions, "laminb1_lad"],
    X8_Quiescent = annot[regions, "8_Quiescent_hmm"]
  )))
}
row_ha <- get_row_annotations(regions)
column_ha <- HeatmapAnnotation(
  loc = substr(groups$subloc, 1, 2),
  subloc = groups$subloc,
  patient = groups$patient
)

ht <- Heatmap(sub_sampens,
  name = "sampens",
  top_annotation = column_ha,
  right_annotation = row_ha,
  show_row_names = FALSE,
  show_column_names = FALSE,
  cluster_columns = FALSE
)
ht_drawn <- draw(ht)
row_ordered <- row_order(ht_drawn)

row_ha <- row_ha[row_ordered, ]

Heatmap(sub_sampens[row_ordered, ],
  name = "sampens",
  top_annotation = column_ha,
  right_annotation = row_ha,
  show_row_names = FALSE,
  show_column_names = FALSE,
  cluster_columns = FALSE,
  cluster_rows = FALSE
) +
  Heatmap(sub_meths[row_ordered, ],
    name = "meths",
    show_row_names = FALSE,
    show_column_names = FALSE,
    cluster_columns = FALSE,
    cluster_rows = FALSE
  )
```

Let us also look at how the normalized sample entropies look like when tested differentially.

```{r}
sub_meths <- do.call(cbind, lapply(seq_len(nrow(groups)), \(i) {
  cols <- meta$colname[meta$patient == groups$patient[i] & meta$subloc == groups$subloc[i]]
  rowMeans(meths[, cols, drop = FALSE], na.rm = TRUE)
}))
colnames(sub_meths) <- paste(groups$subloc, groups$patient, sep = "_")

design <- model.matrix(~ patient + loc, meta)
fit <- lmFit(n_sampens, design)
fit <- eBayes(fit)
regions <- rownames(topTable(fit, coef = "locPT", number = 500))
topTable(fit, coef = "locPT", number = 10)

dim(sub_n_sampens)
dim(sub_meths)
sub_n_sampens <- na.omit(sub_n_sampens[regions, ])
sub_meths <- na.omit(sub_meths[regions, ])
regions <- intersect(rownames(sub_n_sampens), rownames(sub_meths))
sub_n_sampens <- sub_n_sampens[regions, ]
sub_meths <- sub_meths[regions, ]
dim(sub_n_sampens)
dim(sub_meths)

annot <- read_tsv(snakemake@input[["annotation"]], show_col_types = FALSE)
rownames(annot) <- rownames(n_sampens)
get_row_annotations <- function(regions) {
  rowAnnotation(tile_annotation = as.matrix(data.frame(
    pmd = annot[regions, "pmds_pmd"],
    hmd = annot[regions, "hmds_pmd"],
    H3K27me3 = annot[regions, "H3K27me3_chip"],
    H3K9me3 = annot[regions, "H3K9me3_chip"],
    H3K4me3 = annot[regions, "H3K4me3_chip"],
    laminb1 = annot[regions, "laminb1_lad"],
    X8_Quiescent = annot[regions, "8_Quiescent_hmm"]
  )))
}
row_ha <- get_row_annotations(regions)
column_ha <- HeatmapAnnotation(
  loc = substr(groups$subloc, 1, 2),
  subloc = groups$subloc,
  patient = groups$patient
)

ht <- Heatmap(pmin(sub_n_sampens, 1.5),
  name = "norm_sampens",
  top_annotation = column_ha,
  right_annotation = row_ha,
  show_row_names = FALSE,
  show_column_names = FALSE,
  cluster_columns = FALSE
)
ht_drawn <- draw(ht)
row_ordered <- row_order(ht_drawn)

row_ha <- row_ha[row_ordered, ]

Heatmap(sub_n_sampens[row_ordered, ],
  name = "norm_sampens",
  top_annotation = column_ha,
  right_annotation = row_ha,
  show_row_names = FALSE,
  show_column_names = FALSE,
  cluster_columns = FALSE,
  cluster_rows = FALSE
) +
  Heatmap(sub_meths[row_ordered, ],
    name = "meths",
    show_row_names = FALSE,
    show_column_names = FALSE,
    cluster_columns = FALSE,
    cluster_rows = FALSE
  )
```

At this point, one might be interested to look at differentialy entropic regions which are not differentially methylated and vice-versa.
```{r}
sub_sampens <- do.call(cbind, lapply(seq_len(nrow(groups)), \(i) {
  cols <- meta$colname[meta$patient == groups$patient[i] & meta$subloc == groups$subloc[i]]
  rowMeans(sampens[, cols, drop = FALSE], na.rm = TRUE)
}))
colnames(sub_sampens) <- paste(groups$subloc, groups$patient, sep = "_")
sub_meths <- do.call(cbind, lapply(seq_len(nrow(groups)), \(i) {
  cols <- meta$colname[meta$patient == groups$patient[i] & meta$subloc == groups$subloc[i]]
  rowMeans(meths[, cols, drop = FALSE], na.rm = TRUE)
}))
colnames(sub_meths) <- paste(groups$subloc, groups$patient, sep = "_")

design <- model.matrix(~ patient + loc, meta)
fit <- lmFit(sampens, design)
fit <- eBayes(fit)
samp_regions <- rownames(topTable(fit, coef = "locPT", number = 3000))
topTable(fit, coef = "locPT")

fit <- lmFit(meths, design)
fit <- eBayes(fit)
meth_regions <- rownames(topTable(fit, coef = "locPT", number = 3000))
topTable(fit, coef = "locPT")

dim(sub_sampens)
dim(sub_meths)
sub_sampens <- na.omit(sub_sampens[samp_regions, ])
sub_meths_sig <- na.omit(sub_meths[meth_regions, ])
ver_cmr_regions <- setdiff(rownames(sub_sampens), rownames(sub_meths_sig))
sub_sampens <- sub_sampens[ver_cmr_regions, ]
sub_meths <- na.omit(sub_meths[ver_cmr_regions, ])
ver_cmr_regions <- rownames(sub_meths)
sub_sampens <- sub_sampens[ver_cmr_regions, ]
dim(sub_sampens)
dim(sub_meths)

row_ha <- get_row_annotations(ver_cmr_regions)

ht <- Heatmap(sub_sampens,
  name = "sampens",
  top_annotation = column_ha,
  right_annotation = row_ha,
  show_row_names = FALSE,
  show_column_names = FALSE,
  cluster_columns = FALSE
)
ht_drawn <- draw(ht)
row_ordered <- row_order(ht_drawn)

row_ha <- row_ha[row_ordered, ]

Heatmap(sub_sampens[row_ordered, ],
  name = "sampens",
  top_annotation = column_ha,
  right_annotation = row_ha,
  show_row_names = FALSE,
  show_column_names = FALSE,
  cluster_columns = FALSE,
  cluster_rows = FALSE
) +
  Heatmap(sub_meths[row_ordered, ],
    name = "meths",
    show_row_names = FALSE,
    show_column_names = FALSE,
    cluster_columns = FALSE,
    cluster_rows = FALSE
  )
```