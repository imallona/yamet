---
title: "CRC by genomic tiles, first exploration"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    code_download: true
    number_sections: true
    df_print: default # kable
    theme: lumen

---


```{r, setup}
suppressPackageStartupMessages({
  ## library(readr)
  #library(lmerTest)
  library(ggplot2)
  library(knitr)
#  library('effects')
  library(ComplexHeatmap)
  library(viridis)
  ## library(showtext)
  ## library(boot)
})


## options(bitmapType="cairo")
## showtext_auto()
```

```{r}
opts_chunk$set(fig.width = 7.5,
               fig.height = 7.5,
               cache = FALSE,
               include = TRUE,
               dev = "png",
               cache.lazy = FALSE,
               warning = TRUE,
               message = TRUE)
```

```{R logging, include = FALSE}
log <- file(snakemake@log$log, open = "wt")
sink(log)
sink(log, type = "message")
```

# Annotations  {.tabset .tabset-pills}

Caution downsampling


```{r downsampling}
NROWS <- 5e4

```

```{r}

annot <- read.table(gzfile(snakemake@input[['annotations']]), header = TRUE, nrows = NROWS)
# annot <- read.table(gzfile('/home/imallona/src/yamet/workflow/hg19/windows_10000_nt_annotation.gz'),
#                    header = T, nrows = NROWS)
```


First, cluster the annots to make sure they make sense to start with, without any sampens

```{r, fig.width = 12, fig.height = 6}


mannot <- head(annot, NROWS)

plot(hclust(dist(t(mannot))))
```

# Local reports - Shannon {.tabset .tabset-pills}

Caution downsampled

```{r}
filepaths <- list.files( snakemake@params[["output_path"]], pattern = "\\.det\\.out$", full.names = TRUE)

## (filepaths <- list.files('/home/imallona/src/yamet/workflow/data/crc/windows_output',
##                          pattern = "\\.det\\.out$", full.names = TRUE))

## filepaths <- filepaths[!grepl("\\.det\\.out$", filepaths)]
## filepaths <- filepaths[!grepl("\\.meth\\.out$", filepaths)]

regex <- "(.*)_(.*)_(.*).det.out"
process_file <- function(filepath) {
    filename <- basename(filepath)
    patient <- gsub(regex, "\\2", filename)
    location <- gsub(regex, "\\3", filename)
   
  dt <- read.table(filepath, sep = "\t", na.strings = "-1", header = TRUE, nrows = NROWS)
  dt <- dt[, c("shannon", "avg_meth")]

  dt$patient <- patient
  dt$location <- location
  dt$window <- rownames(dt)
  return(dt)
}

## these are mainly shannons! and avgmeths
locals <- do.call(rbind, lapply(filepaths, process_file))

## head(locals)
locals$patient <- as.factor(locals$patient)
locals$location <- factor(locals$location, levels = c('NC', 'PT', 'LN', 'ML', 'MP', 'MO'))
rownames(locals) <- paste(locals$patient, locals$location, rownames(locals), sep = "_")

```

## By location 

```{r, fig.width = 10, fig.height = 10}
par(mfrow = c(3,2), pty = 's')
for (loc in levels(locals$location)) {
    tmp <- locals[locals$location == loc,]
    plot(shannon~avg_meth, col = as.numeric(as.factor(tmp$location)), pch = '.', data = tmp, main = loc)
}
```


## By patient (colored by location as before)

```{r, fig.width = 10, fig.height = 10}
par(mfrow = c(3,3), pty = 's')
for (patient in levels(locals$patient)) {
    tmp <- locals[locals$patient == patient,]
    plot(shannon~avg_meth, col = as.numeric(as.factor(tmp$location)), pch = '.', data = tmp, main = patient[1])
}

```

## By patient and location

```{r, fig.width =8, fig.height = 11}

par(mfrow = c(4,4), pty = 's')
for (patient in levels(locals$patient)) {
    tmp <- locals[locals$patient == patient,]
    for (loc in unique(tmp$location)) {
        tmp <- locals[locals$patient == patient & locals$location == loc,]
        plot(shannon~avg_meth, col = as.numeric(as.factor(tmp$location)),
             pch = '.', data = tmp, main = paste(loc, patient[1]))
    }
}



```

# With window annotations {.tabset} {.tabset-pills}

Let's stratify features by their annots

and these are shannons within patient+location anyway

```{r, fig.width = 10, fig.height = 10}

# the dominant annotation
# gold <- apply(annot, 1, function(row) colnames(annot)[which.max(row != 0)])
gold <- apply(annot, 1, function(row) {
    if (all(row == 0)) {
        res <- NA
    } else { 
        res <- colnames(annot)[which.max(row)]
    }
    res        
})

# the subdominant annotation (the one not being 1 but still max, to avoid long
#  features to prevail over shorter ones)
#  it will pick the first occurrence
# silver <- apply(annot, 1, function(row) colnames(annot)[which.max(row <1 & row != 0)])
silver <- apply(annot, 1, function(row) {
    if (all(row == 0) | sum(row >0) == 1) {
        res <- NA
    } else {
        tmp <- setNames(row, colnames(annot))
        res <- names(tmp)[which.max(tmp< 1 & tmp > 0)]
    }
    res        
})

annot$gold <- gold
annot$silver <- silver
head(annot)

annot$window <- rownames(annot)

locals <- merge(locals, annot[,c('gold', 'silver', 'window')], by = 'window')

```

## By patient and main annot

```{r, fig.width = 10, fig.height = 12}
ggplot(
  locals,
  aes(y = shannon, x = location)
) +
  geom_boxplot(
    outlier.size = 0.6,
    outlier.alpha = 0.3
  ) +
  labs(y = "Shannon entropy") +
  geom_jitter(
    position = position_dodge(width = 0.75),
    size = 0.6, alpha = 0.3
  ) +
    facet_grid(gold~patient) + 
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


```

## Another

```{r, fig.width = 10, fig.height = 8}
ggplot(
  locals,
  aes(y = shannon, x = gold, color = location)
) +
  geom_boxplot(
    outlier.size = 0.6,
    outlier.alpha = 0.3
  ) +
  labs(y = "Shannon entropy") +
  geom_jitter(
    position = position_dodge(width = 0.75),
    size = 0.6, alpha = 0.3
  ) +
    facet_grid(patient~., space = "free") + 
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## Gold vs silver in PTs

```{r, fig.width = 10, fig.height = 8}
ggplot(
  subset(locals, location == 'PT'),
  aes(y = shannon, x = gold, color = silver)
) +
  geom_boxplot(
    outlier.size = 0.6,
    outlier.alpha = 0.3
  ) +
  labs(y = "Shannon entropy") +
  geom_jitter(
    position = position_dodge(width = 0.75),
    size = 0.6, alpha = 0.3
  ) +
    facet_grid(patient~., space = "free") + 
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

<!-- ```{r} -->
<!-- head(locals) -->

<!-- ggplot(locals, -->
<!--        aes( y = shannon, x= silver, color = gold)) + -->
<!--     facet_grid(patient~location, space = "free") +  -->
<!--     geom_boxplot(alpha=1) -->
<!-- ``` -->
