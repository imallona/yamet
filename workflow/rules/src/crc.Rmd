---
title: "CRC exploratory"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    code_download: true
    number_sections: true
    df_print: default # kable
    theme: lumen

---


```{r, setup}
suppressPackageStartupMessages({
  ## library(readr)
  library(lmerTest)
  library(ggplot2)
  library(knitr)
  library('effects')
  library(ComplexHeatmap)
  library(viridis)
  ## library(showtext)
})


## options(bitmapType="cairo")
## showtext_auto()
```

```{r}
opts_chunk$set(fig.width = 7.5,
               fig.height = 7.5,
               cache = FALSE,
               include = TRUE,
               dev = "png",
               cache.lazy = FALSE,
               warning = TRUE,
               message = TRUE)
```

```{R logging, include = FALSE}
log <- file(snakemake@log$log, open = "wt")
sink(log)
sink(log, type = "message")
```

# Short (global) reports by annotation  {.tabset .tabset-pills}

## Modelling

Firstly, we read in the yamet output files and create a table storing the biopsy location, patient id and genomic segmentation.

```{r, import_short_reports}
filepaths <- list.files( snakemake@params[["output_path"]], pattern = "\\.out$", full.names = TRUE)

filepaths <- filepaths[!grepl("\\.det\\.out$", filepaths)]
filepaths <- filepaths[!grepl("\\.meth\\.out$", filepaths)]

process_file <- function(filepath) {
  filename <- basename(filepath)

  annotation <- gsub("(.*)_(.*)_(.*)\\.(.*).out", "\\1", filename)
  patient <- gsub("(.*)_(.*)_(.*)\\.(.*).out", "\\3", filename)
  location <- gsub("(.*)_(.*)_(.*)\\.(.*).out", "\\4", filename)
   
  dt <- read.table(filepath, sep = "\t", na.strings = "-1", header = TRUE)
  dt <- dt[, c("sampen", "avg_meth")]

  dt$annotation <- annotation
  dt$patient <- patient
  dt$location <- location

  return(dt)
}

files <- do.call(rbind, lapply(filepaths, process_file))

files$annotation <- as.factor(files$annotation)
files$patient <- as.factor(files$patient)
files$location <- factor(files$location, levels = c('NC', 'PT', 'LN', 'ML', 'MP'))

```

Patient as random effect

```{r, lmer}
lmer.files <- lmer(
  sampen ~ location * avg_meth + (1 | patient),
  data = subset(files, annotation == "pmds")
)
summary(lmer.files)
anova(lmer.files, type = 3)
```

## Scatters by location and annotation
 
```{r}
ggplot(
  subset(files, patient == "CRC01"),
  aes(y = sampen, x = avg_meth, color = location)
) +
  geom_point(size = 0.9, alpha = 0.2, shape = 19) +
  scale_color_brewer(palette = "Dark2") +
  facet_wrap(~annotation) +
  labs(
    x = "average methylation",
    y = "sample entropy"
  ) +
    guides(color = guide_legend(override.aes = list(size = 2))) +
    theme_bw() +
    theme(aspect.ratio=1)
```

## sampEn boxes by location and annotation

```{r, fig.height = 4}
ggplot(
  subset(files, patient == "CRC01"),
  aes(y = sampen, x = annotation, color = location)
) +
  geom_boxplot(
    outlier.size = 0.6,
    outlier.alpha = 0.3
  ) +
  labs(y = "sample entropy") +
  geom_jitter(
    position = position_dodge(width = 0.75),
    size = 0.6, alpha = 0.3
  ) +
  scale_color_brewer(palette = "Dark2") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## meth boxes by location and annotation

```{r, fig.height = 4}
ggplot(
  subset(files, patient == "CRC01"),
  aes(y = avg_meth, x = annotation, color = location)
) +
  geom_boxplot(
    outlier.size = 0.6,
    outlier.alpha = 0.3
  ) +
  labs(y = "average methylation") +
  geom_jitter(
    position = position_dodge(width = 0.75),
    size = 0.6, alpha = 0.3
  ) +
    scale_color_brewer(palette = "Dark2") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

# Full (local) reports for **downsampled** PMDs and CRC01

Caution downsampled to some rows only.

```{r, import_log_reports}

DOWNSAMPLING <- 5e4

process_det_report <- function(filepath) {
  filename <- basename(filepath)

  dt <- read.table(filepath, sep = "\t", na.strings = "-1", header = TRUE, nrows = DOWNSAMPLING)
  colnames(dt) <- basename(colnames(dt))
  return(dt)
}


annotation <- 'pmds'
patient <- 'CRC01'

local <- list()
for (location in c('NC', 'PT', 'LN', 'ML', 'MP')) {
    filepaths <- list.files( snakemake@params[["output_path"]], pattern = "\\.det\\.out$", full.names = TRUE)
    filepaths <- grep(location, filepaths, value = TRUE)
    filepaths <- grep(annotation, filepaths, value = TRUE)
    filepaths <- grep(patient, filepaths, value = TRUE)
    
    d <- lapply(filepaths, function(x) {
        tmp <- process_det_report(x)
        ## tmp$avg_sampen <- apply(tmp[,grep(location, colnames(tmp))], 1, function(y) mean(y, na.rm = TRUE))
        ## tmp$median_sampen <- apply(tmp[,grep(location, colnames(tmp))], 1, function(y) median(y, na.rm = TRUE))
    })

    d2 <- lapply(d, function(x) {
        avg_sampen <- apply(x[,grep(location, colnames(x))], 1, function(y) mean(y, na.rm = TRUE))
        median_sampen <- apply(x[,grep(location, colnames(x))], 1, function(y) median(y, na.rm = TRUE))
        q25_sampen <- apply(x[,grep(location, colnames(x))], 1, function(y) quantile(y, 0.25, na.rm = TRUE))
        q75_sampen <- apply(x[,grep(location, colnames(x))], 1, function(y) quantile(y, 0.75, na.rm = TRUE))
        return(cbind(x, data.frame(avg_sampen = avg_sampen, median_sampen = median_sampen,
                                   q25_sampen = q25_sampen, q75_sampen = q75_sampen,
                                   location = location,
                                   patient = patient,
                                   annotation = annotation)))
    })
    
    local[[location]] <- d2[[1]]
    rm(d, d2)
}



```

## Scatters {.tabset .tabset-pills}

### By meth NC


```{r, fig.width = 10, fig.height = 10}

saveRDS(local, file = 'local_debug.rds')

pal <- viridis(10, alpha = 0.8)

beta2m <- function (betas, epsilon = 1e-05) 
{
  if (!is.numeric(betas)) {
    stop("Non-numeric betas")
  }
  if (!(is.numeric(epsilon)  && (!is.na(epsilon)))) {
    stop("Epison not valid")
  }
  if (epsilon < 0 || epsilon >= 0.5) {
    stop("Not 0 < epsilon < 0.5")
  }
  betas[betas < epsilon] <- epsilon
  betas[betas > (1 - epsilon)] <- 1 - epsilon
  return(log2(betas/(1 - betas)))
}

pmds <- data.frame(shannon_NC = local$NC$shannon,
                   ## meth_NC_m = beta2m(local$NC$avg_meth),
                   meth_NC = local$NC$avg_meth,                   
                   med_sampen_NC = local$NC$median_sampen,
                   shannon_PT = local$PT$shannon,
                   ## meth_PT_m = beta2m(local$PT$avg_meth),
                   meth_PT = local$PT$avg_meth,
                   med_sampen_PT = local$PT$median_sampen)
pmds$meth_change <- pmds$meth_PT - pmds$meth_NC
pmds <- na.omit(pmds)

pmds$by_meth_nc <- cut(pmds$meth_NC, breaks = 10)
pmds$by_meth_pt <- cut(pmds$meth_PT, breaks = 10)

plot(pmds[,grep('by', colnames(pmds), invert = TRUE)],
     pch = ".", col = pal[as.numeric(pmds$by_meth_nc)], main = 'by_meth_nc')
```

### By median sampen PT


```{r, fig.width = 10, fig.height = 10}

pmds$by_med_sampen_pt <- cut(pmds$med_sampen_PT, breaks = 10)
plot(pmds[,grep('by', colnames(pmds), invert = TRUE)],
     pch = ".", col = pal[as.numeric(pmds$by_med_sampen_pt)], main = "by_med_sampen_PT")

```

### By median sampen NC

```{r, fig.width = 10, fig.height = 10, results = 'asis'}
pmds$by_med_sampen_nc <- cut(pmds$med_sampen_NC, breaks = 10)
plot(pmds[,grep('by', colnames(pmds), invert = TRUE)],
     pch = ".", col = pal[as.numeric(pmds$by_med_sampen_nc)], main = "by_med_sampen_nc")

```

### By methylation change

```{r, fig.width = 10, fig.height = 10, results = 'asis'}
pmds$by_meth_change <- cut(pmds$meth_change, breaks = 10)
plot(pmds[,grep('by', colnames(pmds), invert = TRUE)],
     pch = ".", col = pal[as.numeric(pmds$by_meth_change)], main = "by_meth_change")
```

Add extra discretization.

```{r}
pmds$by_sampen_pt <- cut(pmds$med_sampen_PT, breaks = 10)
pmds$by_sampen_nc <- cut(pmds$med_sampen_NC, breaks = 10)
pmds$by_shannon_pt <- cut(pmds$shannon_PT, breaks = 10)
pmds$by_shannon_nc <- cut(pmds$shannon_NC, breaks = 10)
```

## Some modelling {.tabset .tabset-pills}

### sampEn NC and meth NC matters

```{r, fig.width=4, fig.height=4}

m1 <- lmer(
  med_sampen_PT ~  med_sampen_NC * meth_NC + (1 | by_meth_pt) ,
  data = pmds)

summary(m1)
plot(m1)
anova(m1, type = 3)

```

```{r}

ee1 <- Effect(c("med_sampen_NC","meth_NC"), m1)
plot(ee1)

```

### sampen NC and meth increase matters


```{r, fig.width=4, fig.height=4}

m2 <- lmer(
  med_sampen_PT ~  med_sampen_NC + meth_NC:meth_PT +  (1 | by_meth_pt),
  data = pmds)

summary(m2)
plot(m2)
anova(m2, type = 3)
```

```{r}
ee2 <- Effect(c("meth_PT", "meth_NC"), m2)
plot(ee2)
```

```{r}

anova(m1,m2)
```

### Shannon NC and meth PT matters

```{r, fig.width=4, fig.height=4}

m3 <- lmer(
  med_sampen_PT ~  shannon_NC * meth_PT +  (1 | meth_NC) + (1 | by_med_sampen_nc),
  data = pmds)

summary(m3)
plot(m3)
anova(m3, type = 3)
```

```{r}
anova(m1,m2,m3)
```

```{r}

ee3 <- Effect(c("meth_PT", "shannon_NC"), m3)
plot(ee3)
```

### On model 1 again

```{r, fig.width=10, fig.height = 5}

fe <- fixef(m1)
re <- ranef(m1)$by_meth_pt

## pal <- terrain.colors(nrow(re), alpha = 0.2)
## pal_solid <- terrain.colors(nrow(re), alpha = 1)
## m1 <- lmer(
##   med_sampen_PT ~  med_sampen_NC * meth_NC + (1 | meth_PT) ,
##   data = pmds)

par(mfrow=c(1, 2))

plot(med_sampen_PT ~ med_sampen_NC * meth_NC, data = pmds,
     col=pal[as.numeric(by_meth_pt)], main='Pred', pch = 19)
lapply(seq_len(nrow(re)), \(x) abline(fe[1] + re[x, 1], fe[2] + re[x, 1], col=pal[x]))

```

# Hypothesis-driven (for PMDs but also for other compartments) }


## Still exploratory {.tabset .tabset-pills}

### Ranks associations - by meth PT

```{r, fig.width = 8, fig.height = 8}


pmds <- pmds[order(pmds$meth_change),]
pmds$meth_change_rank <- rank(pmds$meth_change, ties.method = "average")

pmds$meth_nc_rank <- rank(pmds$meth_NC, ties.method = "average")
pmds$shannon_nc_rank <- rank(pmds$shannon_NC, ties.method = "average")
pmds$sampen_nc_rank <- rank(pmds$med_sampen_NC, ties.method = "average")

pmds$meth_pt_rank <- rank(pmds$meth_PT, ties.method = "average")
pmds$shannon_pt_rank <- rank(pmds$shannon_PT, ties.method = "average")
pmds$sampen_pt_rank <- rank(pmds$med_sampen_PT, ties.method = "average")


plot(pmds[,c(grep('rank', colnames(pmds), value = TRUE), 'meth_PT')],
     pch = '.', col = pal[as.numeric(pmds$by_meth_pt)], main = 'by meth pt')
```

### Ranks associations - by sampEn PT

```{r, fig.width = 8, fig.height = 8}

plot(pmds[,c(grep('rank', colnames(pmds), value = TRUE), 'med_sampen_PT')],
     pch = '.', col = pal[as.numeric(pmds$by_sampen_pt)], main = 'by sampen pt')

```

### Ranks associations - by sampEn NC

```{r, fig.width = 8, fig.height = 8}

plot(pmds[,c(grep('rank', colnames(pmds), value = TRUE), 'med_sampen_NC')],
     pch = '.', col = pal[as.numeric(pmds$by_sampen_nc)], main = 'by sampen nc')

```

### Ranks associations - by shannon PT

```{r, fig.width = 8, fig.height = 8}

plot(pmds[,c(grep('rank', colnames(pmds), value = TRUE), 'shannon_PT')],
     pch = '.', col = pal[as.numeric(pmds$by_shannon_pt)], main = 'by shannon pt')

```

### Ranks associations - by shannon PT

```{r, fig.width = 8, fig.height = 8}

plot(pmds[,c(grep('rank', colnames(pmds), value = TRUE), 'shannon_NC')],
     pch = '.', col = pal[as.numeric(pmds$by_shannon_nc)], main = 'by shannon nc')

```

### Heatmap

```{r, fig.width = 6, fig.height = 6}

Heatmap(pmds[,c('meth_NC', 'med_sampen_NC',  'shannon_NC',
                'meth_PT', 'med_sampen_PT',  'shannon_PT',
                'meth_change'
                )
             ],
        cluster_rows = FALSE, cluster_columns = FALSE,
        col = rev(rainbow(10)),
        show_row_names = FALSE)
```

## Hypomethylation NC -> PT is inversely correlated with starting NC meth level



## Hypomethylation NC -> PT has to do with sampEn increase

## Hypomethylation NC -> PT has to do with with NC Shannon (diversity)






# Session

```{r, cache = FALSE}
sessionInfo()
```
