---
title: "CRC by feature (no windows)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
author: "Izaskun Mallona"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    code_download: true
    number_sections: true
    df_print: default # kable
    theme: lumen

---


```{r, setup}
suppressPackageStartupMessages({
  ## library(readr)
  library(lmerTest)
  library(ggplot2)
  library(knitr)
  library(effects)
  library(ComplexHeatmap)
  library(viridis)
  library(BiocParallel)
})

source("src/ggtheme.R")
param <- MulticoreParam(workers = snakemake@threads)
```

```{r}
opts_chunk$set(
  fig.width = 7.5,
  fig.height = 7.5,
  cache = FALSE,
  include = TRUE,
  fig.path = "crc_plots/",
  dev = c("png", "svg"),
  dpi = 500,
  cache.lazy = FALSE,
  warning = TRUE,
  message = TRUE
)
```

```{R logging, include = FALSE}
log <- file(snakemake@log$log, open = "wt")
sink(log)
sink(log, type = "message")
```

# Short (global) reports by annotation  {.tabset .tabset-pills}

## Modelling

Firstly, we read in the yamet output files and create a table storing the biopsy location, patient id and genomic segmentation.

```{r, import_short_reports}
filepaths <- list.files(snakemake@params[["output_path"]], pattern = "\\.out\\.gz$", full.names = TRUE)

filepaths <- filepaths[!grepl("\\.det\\.out\\.gz$", filepaths)]
filepaths <- filepaths[!grepl("\\.norm\\.out\\.gz$", filepaths)]
filepaths <- filepaths[!grepl("\\.meth\\.out\\.gz$", filepaths)]

regex <- "(.*)_(.*)_(.*)_(.*).out.gz"
process_file <- function(filepath) {
  filename <- basename(filepath)

  dt <- read.table(gzfile(filepath), sep = "\t", na.strings = "-1", header = TRUE)
  dt <- dt[, c("sampen", "avg_meth")]

  dt$annotation <- gsub(regex, "\\1", filename)
  dt$patient <- gsub(regex, "\\3", filename)
  dt$location <- gsub(regex, "\\4", filename)

  return(dt)
}

files <- do.call(rbind, bplapply(filepaths, process_file, BPPARAM = param))

files$annotation <- as.factor(files$annotation)
files$patient <- as.factor(files$patient)
files$location <- factor(files$location, levels = c("NC", "PT", "LN", "ML", "MP", "MO"))
```

Patient as random effect

```{r, lmer}
lmer.files <- lmer(
  sampen ~ location * avg_meth + (1 | patient),
  data = subset(files, annotation == "pmds")
)
summary(lmer.files)
anova(lmer.files, type = 3)
```

## Scatters by location and annotation
 
```{r}
ggplot(
  ## subset(files, patient == "CRC01"),
  files,
  aes(y = sampen, x = avg_meth, color = location, shape = patient)
) +
  geom_point(size = 0.9, alpha = 0.2) +
  scale_color_brewer(palette = "Set1") +
  scale_shape_manual(values = 1:nlevels(files$patient)) +
  facet_wrap(~annotation) +
  labs(
    x = "average methylation",
    y = "sample entropy"
  ) +
  guides(color = guide_legend(override.aes = list(size = 2))) +
  theme_ng()
```

## Scatters by location and annotation and patient
 
```{r, fig.height = 15}
ggplot(
  ## subset(files, patient == "CRC01"),
  files,
  aes(y = sampen, x = avg_meth, color = location)
) +
  geom_point(size = 0.9, alpha = 0.2) +
  scale_color_brewer(palette = "Set1") +
  facet_grid(annotation ~ patient) +
  labs(
    x = "average methylation",
    y = "sample entropy"
  ) +
  guides(color = guide_legend(override.aes = list(size = 2))) +
  theme_ng() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## Scatters by location and annotation and patient (shorter)
 
```{r, fig.height = 3.2}
ggplot(
  subset(files, annotation %in% c("laminb1", "H3K27me3", "H3K9me3")),
  aes(y = sampen, x = avg_meth, color = location)
) +
  geom_point(size = 0.9, alpha = 0.2) +
  scale_color_brewer(palette = "Set1") +
  facet_grid(annotation ~ patient) +
  labs(
    x = "average methylation",
    y = "sample entropy"
  ) +
  guides(color = guide_legend(override.aes = list(size = 2))) +
  theme_ng() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## sampEn boxes by location and annotation - crc01

```{r, fig.height = 6, fig.width = 10}
ggplot(
  subset(files, patient == "CRC01"),
  aes(y = sampen, x = annotation, color = location)
) +
  geom_boxplot(
    outlier.size = 0.6,
    outlier.alpha = 0.3
  ) +
  labs(y = "sample entropy") +
  geom_jitter(
    position = position_dodge(width = 0.75),
    size = 0.6, alpha = 0.3
  ) +
  scale_color_brewer(palette = "Dark2") +
  theme_ng() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## meth boxes by location and annotation - crc01

```{r, fig.height = 6, fig.width = 10}
ggplot(
  subset(files, patient == "CRC01"),
  aes(y = avg_meth, x = annotation, color = location)
) +
  geom_boxplot(
    outlier.size = 0.6,
    outlier.alpha = 0.3
  ) +
  labs(y = "average methylation") +
  geom_jitter(
    position = position_dodge(width = 0.75),
    size = 0.6, alpha = 0.3
  ) +
  scale_color_brewer(palette = "Dark2") +
  theme_ng() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

# Full (local) reports for **downsampled** PMDs and CRC01

Caution downsampled to some rows only.

```{r, import_log_reports}
DOWNSAMPLING <- 5e4

process_det_report <- function(filepath) {
  filename <- basename(filepath)
  dt <- read.table(gzfile(filepath), sep = "\t", na.strings = "-1", header = TRUE, nrows = DOWNSAMPLING)
  colnames(dt) <- basename(colnames(dt))
  return(dt)
}

annotation <- "pmds"
patient <- "CRC01"

local <- list()
for (location in c("NC", "PT", "LN", "ML", "MP")) {
  filepaths <- list.files(snakemake@params[["output_path"]], pattern = "\\.det\\.out\\.gz$", full.names = TRUE)
  filepaths <- grep(location, filepaths, value = TRUE)
  filepaths <- grep(annotation, filepaths, value = TRUE)
  filepaths <- grep(patient, filepaths, value = TRUE)

  d <- bplapply(filepaths, \(filepath) {
    filename <- basename(filepath)
    dt <- read.table(gzfile(filepath), sep = "\t", na.strings = "-1", header = TRUE, nrows = DOWNSAMPLING)
    colnames(dt) <- basename(colnames(dt))
    dt
  }, BPPARAM = param)

  d2 <- bplapply(d, function(x) {
    avg_sampen <- apply(x[, grep(location, colnames(x))], 1, function(y) mean(y, na.rm = TRUE))
    median_sampen <- apply(x[, grep(location, colnames(x))], 1, function(y) median(y, na.rm = TRUE))
    q25_sampen <- apply(x[, grep(location, colnames(x))], 1, function(y) quantile(y, 0.25, na.rm = TRUE))
    q75_sampen <- apply(x[, grep(location, colnames(x))], 1, function(y) quantile(y, 0.75, na.rm = TRUE))
    return(cbind(x, data.frame(
      avg_sampen = avg_sampen, median_sampen = median_sampen,
      q25_sampen = q25_sampen, q75_sampen = q75_sampen,
      location = location,
      patient = patient,
      annotation = annotation
    )))
  }, BPPARAM = param)

  local[[location]] <- d2[[1]]
  rm(d, d2)
}
```

## Scatters {.tabset .tabset-pills}

### By meth NC

```{r, fig.width = 10, fig.height = 10}
saveRDS(local, file = "local_debug.rds")

pal <- viridis(10, alpha = 0.8)

beta2m <- function(betas, epsilon = 1e-05) {
  if (!is.numeric(betas)) {
    stop("Non-numeric betas")
  }
  if (!(is.numeric(epsilon) && (!is.na(epsilon)))) {
    stop("Epison not valid")
  }
  if (epsilon < 0 || epsilon >= 0.5) {
    stop("Not 0 < epsilon < 0.5")
  }
  betas[betas < epsilon] <- epsilon
  betas[betas > (1 - epsilon)] <- 1 - epsilon
  return(log2(betas / (1 - betas)))
}

pmds <- data.frame(
  shannon_NC = local$NC$shannon,
  ## meth_NC_m = beta2m(local$NC$avg_meth),
  meth_NC = local$NC$avg_meth,
  med_sampen_NC = local$NC$median_sampen,
  shannon_PT = local$PT$shannon,
  ## meth_PT_m = beta2m(local$PT$avg_meth),
  meth_PT = local$PT$avg_meth,
  med_sampen_PT = local$PT$median_sampen
)
pmds$meth_change <- pmds$meth_PT - pmds$meth_NC
pmds <- na.omit(pmds)

pmds$by_meth_nc <- cut(pmds$meth_NC, breaks = 10)
pmds$by_meth_pt <- cut(pmds$meth_PT, breaks = 10)

plot(pmds[, grep("by", colnames(pmds), invert = TRUE)],
  pch = ".", col = pal[as.numeric(pmds$by_meth_nc)], main = "by_meth_nc"
)
```

### By median sampen PT


```{r, fig.width = 10, fig.height = 10}
pmds$by_med_sampen_pt <- cut(pmds$med_sampen_PT, breaks = 10)
plot(pmds[, grep("by", colnames(pmds), invert = TRUE)],
  pch = ".", col = pal[as.numeric(pmds$by_med_sampen_pt)], main = "by_med_sampen_PT"
)
```

### By median sampen NC

```{r, fig.width = 10, fig.height = 10, results = 'asis'}
pmds$by_med_sampen_nc <- cut(pmds$med_sampen_NC, breaks = 10)
plot(pmds[, grep("by", colnames(pmds), invert = TRUE)],
  pch = ".", col = pal[as.numeric(pmds$by_med_sampen_nc)], main = "by_med_sampen_nc"
)
```

### By methylation change

```{r, fig.width = 10, fig.height = 10, results = 'asis'}
pmds$by_meth_change <- cut(pmds$meth_change, breaks = 10)
plot(pmds[, grep("by", colnames(pmds), invert = TRUE)],
  pch = ".", col = pal[as.numeric(pmds$by_meth_change)], main = "by_meth_change"
)
```

Add extra discretization.

```{r}
pmds$by_sampen_pt <- cut(pmds$med_sampen_PT, breaks = 10)
pmds$by_sampen_nc <- cut(pmds$med_sampen_NC, breaks = 10)
pmds$by_shannon_pt <- cut(pmds$shannon_PT, breaks = 10)
pmds$by_shannon_nc <- cut(pmds$shannon_NC, breaks = 10)
```

# Session

```{r, cache = FALSE}
sessionInfo()
```
